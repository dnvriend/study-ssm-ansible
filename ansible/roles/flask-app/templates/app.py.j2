#!/usr/bin/env python3
"""
Flask Application - Study SSM Ansible
A simple Flask application demonstrating web deployment with Ansible.
"""

import os
import socket
import logging
from flask import Flask, jsonify
from werkzeug.middleware.proxy_fix import ProxyFix

# Configuration
DATABASE_URL = os.getenv('DATABASE_URL', 'sqlite:///opt/flask-app/app.db')
SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
APP_ENVIRONMENT = os.getenv('APP_ENVIRONMENT', 'development')
LOG_LEVEL = os.getenv('APP_LOG_LEVEL', 'INFO')

# Configure logging
logging.basicConfig(
    level=getattr(logging, LOG_LEVEL),
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# Initialize Flask application
app = Flask(__name__)
app.wsgi_app = ProxyFix(app.wsgi_app, x_for=1, x_proto=1, x_host=1, x_prefix=1)
app.config['SECRET_KEY'] = SECRET_KEY
app.config['ENVIRONMENT'] = APP_ENVIRONMENT
app.config['DATABASE_URL'] = DATABASE_URL


@app.route('/')
def index():
    """Root endpoint - Returns application status and information."""
    return jsonify({
        'status': 'ok',
        'message': 'Flask application is running',
        'hostname': socket.gethostname(),
        'environment': APP_ENVIRONMENT,
        'version': '1.0.0'
    })


@app.route('/health')
def health():
    """Health check endpoint for load balancer monitoring."""
    return jsonify({
        'status': 'healthy',
        'hostname': socket.gethostname()
    }), 200


@app.route('/info')
def info():
    """Instance metadata endpoint."""
    return jsonify({
        'hostname': socket.gethostname(),
        'fqdn': socket.getfqdn(),
        'environment': APP_ENVIRONMENT,
        'python_version': os.sys.version,
        'database_configured': DATABASE_URL != 'sqlite:///opt/flask-app/app.db',
        'log_level': LOG_LEVEL
    })


@app.errorhandler(404)
def not_found(error):
    """Handle 404 errors."""
    return jsonify({
        'status': 'error',
        'message': 'Endpoint not found'
    }), 404


@app.errorhandler(500)
def internal_error(error):
    """Handle 500 errors."""
    logger.error(f"Internal server error: {error}")
    return jsonify({
        'status': 'error',
        'message': 'Internal server error'
    }), 500


if __name__ == '__main__':
    logger.info(f"Starting Flask application in {APP_ENVIRONMENT} mode")
    logger.info(f"Database URL: {DATABASE_URL}")
    logger.info(f"Log level: {LOG_LEVEL}")
    app.run(host='0.0.0.0', port=5000, debug=False)
